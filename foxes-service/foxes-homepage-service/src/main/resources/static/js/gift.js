(function(){window.bookGift={giftType:2,bookId:0,bookIsVip:false,giftTabIndex:-1,giftInfo:{},sendMonTicketCount:1,sendAssessTicketCount:1,sendGiftCount:1,giftLoading:false,reviewLoading:false,hasInitSlider:false,giftCommentText:["小主真是写的一手好文章，当受此赏！","技惊四座、妙笔生花，仅以此赏聊表心意","打赏不需要理由，就这么任性！","小小打赏略表心意，继续加油写文噢~"],addFensiCount:0,addMonticketCount:0,todayCanSendMonticketCount:100,monthCanSendMonticketCount:100,monticketMultiple:1,hasBindAction:false,dom:{box:$("#giftBox"),boxContent:$("#giftBoxConetnt"),commentInput:null,commentWords:null,dashangBtn:null,dashangGiftCount:null,dashangText:null,giftCommentCheckBox:null,giftCommentInput:null},expensiveGift:{introCookieName:"pcexpensivegiftintro",introObj:null,giftCountSetObj:null,surplusTextObj:null,surplus1:0,surplus2:0,surplus3:3},init:function(t,e,i,n){this.bookId=e;this.bookIsVip=i;this.initGiftConetnt(t,n);this.dom.box.show()},initGiftStaticData:function(){this.giftType=2;this.giftTabIndex=-1;this.sendMonTicketCount=1;this.sendAssessTicketCount=1;this.sendGiftCount=1;this.giftLoading=false;this.reviewLoading=false;this.hasInitSlider=false},initGiftConetnt:function(t,e){var i=this.bookIsVip?1:0;var n=this;$.get("/partview/GetSendGiftBox",$.param({bookid:n.bookId,isvip:i}),function(i){n.dom.boxContent.html(i);$("#votestar").raty({space:false,width:315,size:45,halfShow:false,targetKeep:true,targetType:"number",targetText:"0",targetFormat:"+{score}",target:"#starchoose",starOff:"../content/pic/star/star-off-big.png",starOn:"../content/pic/star/star-on-big.png"});if(t==2){n.hasInitSlider=true}n.initGiftData(t);if(!e)$("#bonussendmonticnotice").remove();$("#giftview").show();if(t==2){n.arewardSlider();n.setCoin()}})},arewardSlider:function(){$("#chooseitem").bxSlider({mode:"horizontal",infiniteLoop:false,hideControlOnEnd:true,touchEnabled:false})},initGiftData:function(t){this.dom.dashangBtn=$("#sendbtndashang");this.dom.dashangGiftCount=$("#giftnumber");this.dom.dashangText=$("#dashangText");this.dom.commentInput=$("#comment");this.dom.commentWords=$("#cmtLenght");this.dom.giftCommentCheckBox=$("#gift-comment");this.dom.giftCommentInput=$("#gift-comment-input");var e=Math.floor(Math.random()*this.giftCommentText.length);this.dom.giftCommentInput.val(this.giftCommentText[e]);_userInfo.account=parseInt($("#giftaccount").val());_userInfo.yuanbao=parseInt($("#giftyuanbao").val());_userInfo.monTicket=parseInt($("#giftmonticcount").val());_userInfo.assessTicket=parseInt($("#giftassticcount").val());this.monticketMultiple=parseInt($("#monticketmultiple").val());this.expensiveGift.introObj=$("#expensivegift-intro");this.expensiveGift.giftCountSetObj=$("#set-giftcount-btn");this.expensiveGift.surplusTextObj=$("#expensive-surplus");this.expensiveGift.surplus1=parseInt($("#expensivegiftsurplus1").val());this.expensiveGift.surplus2=parseInt($("#expensivegiftsurplus2").val());this.expensiveGift.surplus3=parseInt($("#expensivegiftsurplus3").val());if($("#todaycansendmonticketcount").length>0)this.todayCanSendMonticketCount=parseInt($("#todaycansendmonticketcount").val());if($("#monthcansendmonticketcount").length>0)this.monthCanSendMonticketCount=parseInt($("#monthcansendmonticketcount").val());if(this.expensiveGift.introObj.length>0&&myhead.getCookie(this.expensiveGift.introCookieName)!=2){this.expensiveGift.introObj.css("display","block");myhead.setCookie(this.expensiveGift.introCookieName,2,999);var i=this;$(".expensivegift-intro-close").click(function(){i.expensiveGift.introObj.remove()})}this.setMonTicket();this.setAssTicket();this.setGiftBoxTab(t);this.bindDomAction()},bindDomAction:function(){if(this.hasBindAction)return;this.hasBindAction=true;var t=this;$("#giftboxclose").click(function(){t.dom.box.hide();t.dom.boxContent.html('<p class="giftboxloading">正在加载 . . .</p>');t.initGiftStaticData()});t.dom.boxContent.on("click",".onlyclick .tab-hd span",function(){var e=$(this).index();t.setGiftBoxTab(e)});t.dom.boxContent.on("click","#chooseitem li",function(){if($(this).hasClass("active"))return;$(this).parents("#chooseitem").find("li").removeClass("active");$(this).addClass("active");t.setGiftInfo();if(t.giftType>=38&&t.giftType<=40){var e="";if(t.giftType==38){e="女王斗篷，今日还剩"+t.expensiveGift.surplus1+"件"}else if(t.giftType==39){e="至尊权杖，今日还剩"+t.expensiveGift.surplus2+"根"}else{e="绝代佳人，今日还剩"+t.expensiveGift.surplus3+"个"}t.dom.dashangGiftCount.val(1).attr("disabled",true);t.expensiveGift.surplusTextObj.html(e)}else{t.dom.dashangGiftCount.attr("disabled",false);t.expensiveGift.surplusTextObj.html("")}t.afterSetNum(t.giftType)});t.dom.boxContent.on("click",".btn-plus, .action-plus",function(){if(t.giftType>=38&&t.giftType<=40)return;var e=$(this).siblings("input");t.setNum(e,1)});t.dom.boxContent.on("click",".btn-minus, .action-minus",function(){if(t.giftType>=38&&t.giftType<=40)return;var e=$(this).siblings("input");t.setNum(e,-1)});t.dom.boxContent.on("click",".sendgiftbtn",function(){if($(this).hasClass("forbid"))return;if(t.giftLoading)return;var e=parseInt($(this).attr("data-type"));if(e==0){e=t.giftType}t.giftType=e;if((e==38||e==39||e==40)&&$(this).attr("data-recharge")==1){giftRecharge.init(e,t.giftInfo.worth,t.bookId)}else{t.sendGift()}});t.dom.boxContent.on("click","#postReviewBtn",function(){t.sendComment($(this))})},numChange:function(t,e,i){var n=$("#"+t);var s=parseInt(n.val());if(isNaN(s)||s<0){i?n.val(0):n.val("")}else{n.val(s)}if(e==0){e=this.giftType}this.afterSetNum(e)},setNum:function(t,e){if(e!=0){var i=parseInt(t.val());if(!i)i=0;i+=e;if(i<=0)i=1;t.val(i)}var n=parseInt(t.attr("data-type"));if(n==0)n=this.giftType;this.afterSetNum(n)},afterSetNum:function(t){switch(t){case 4:this.setMonTicket();break;case 8:this.setAssTicket();break;default:this.setCoin();break}},setGiftBoxTab:function(t){if(this.giftTabIndex==t)return;this.giftTabIndex=t;$("#gifttab"+t).addClass("active").siblings().removeClass("active");$("#gifttabcontent"+t).show().siblings().hide();if(t==0){this.giftType=8;this.giftInfo={name:"评价票",unitname:"张",worth:200,exSendMonticketCount:0}}else if(t==1){this.giftType=4;this.giftInfo={name:"月票",unitname:"张",worth:100,exSendMonticketCount:0}}else if(t==2){this.setGiftInfo()}},setGiftInfo:function(){var t=$("#chooseitem li.active");this.giftType=parseInt(t.attr("data-type"));this.giftInfo={name:t.attr("data-name"),unitname:t.attr("data-unitname"),worth:parseInt(t.attr("data-worth")),exSendMonticketCount:parseInt(t.attr("data-exmonticket"))||0};if(!this.hasInitSlider){this.hasInitSlider=true;this.arewardSlider();this.setCoin()}},setCoin:function(){var t=parseInt(this.dom.dashangGiftCount.val());if(!t){t=0}this.sendGiftCount=t;var e=t*this.giftInfo.worth;var i=(Math.floor(e/1e4)+this.giftInfo.exSendMonticketCount*t)*this.monticketMultiple;var n=i*100+e;var s="本次打赏花费<em>"+e+"</em>潇湘币，粉丝值<em>+"+n+"</em>";if(i>0){s+="，赠送<em>"+i+"</em>张月票"}if(e>_userInfo.account){if(this.giftType==38||this.giftType==39||this.giftType==40){this.dom.dashangBtn.removeClass("forbid").html("一键快捷打赏");this.dom.dashangBtn.attr("data-recharge",1)}else{this.dom.dashangBtn.addClass("forbid").html("余额不足");this.dom.dashangBtn.attr("data-recharge",0)}}else{if(e==0){this.dom.dashangBtn.addClass("forbid").html("确认打赏")}else{this.dom.dashangBtn.removeClass("forbid").html("确认打赏")}this.dom.dashangBtn.attr("data-recharge",0)}this.addFensiCount=n;this.addMonticketCount=i;this.dom.dashangText.html(s)},setMonTicket:function(){if(!this.bookIsVip){return}var t=parseInt($("#nummon").val());if(!t){t=0}if(t>this.todayCanSendMonticketCount){$("#sendbtnmon").addClass("forbid").html("超出作品可投上限")}else if(_userInfo.monTicket>=t){if(t==0){$("#sendbtnmon").addClass("forbid").html("确认投给本书")}else{$("#sendbtnmon").removeClass("forbid").html("确认投给本书")}}else{$("#sendbtnmon").addClass("forbid").html("月票余额不足")}$("#monTicketLess").html(_userInfo.monTicket);$("#todaycansendmonticketless").html(this.todayCanSendMonticketCount);$("#monthcansendmonticketless").html(this.monthCanSendMonticketCount);this.sendMonTicketCount=t},setAssTicket:function(){var t=parseInt($("#numass").val());if(!t){t=0}if(_userInfo.account<(t-_userInfo.assessTicket)*200){$("#sendbtnassess").addClass("forbid").html("余额不足")}else{if(t==0){$("#sendbtnassess").addClass("forbid").html("确认投给本书")}else{$("#sendbtnassess").removeClass("forbid").html("确认投给本书")}}$("#assessTicketLess").html(_userInfo.assessTicket);$("#assessTicketBuy").html(Math.floor(_userInfo.account/200));this.sendAssessTicketCount=t},sendGift:function(){var t=0;var e=0;var i="";var n;switch(this.giftType){case 4:t=this.sendMonTicketCount;n=$("#sendbtnmon");if(this.todayCanSendMonticketCount==0){Util.showMsgBox("您对此作品可投月票数量已达限制");return}else if(t>this.todayCanSendMonticketCount){Util.showMsgBox("您今日最多可投给此作品"+this.todayCanSendMonticketCount+"张月票");return}break;case 8:t=this.sendAssessTicketCount;e=parseInt($("#votestar input").val());if(!e||e<=0){Util.showMsgBox("请选择评分");return}n=$("#sendbtnassess");break;case 38:t=1;n=this.dom.dashangBtn;if(t>this.expensiveGift.surplus1){Util.showMsgBox("当前女王斗篷已售完，请选择其他礼物");return}break;case 39:t=1;n=this.dom.dashangBtn;if(t>this.expensiveGift.surplus2){Util.showMsgBox("当前至尊权杖已售完，请选择其他礼物");return}break;case 40:t=1;n=this.dom.dashangBtn;if(t>this.expensiveGift.surplus3){Util.showMsgBox("当前绝代佳人已售完，请选择其他礼物");return}break;default:t=this.sendGiftCount;n=this.dom.dashangBtn;if(this.dom.giftCommentCheckBox.is(":checked")){i=this.formatComment(this.dom.giftCommentInput.val())}break}if(t<=0){Util.showMsgBox("礼物数量必须大于0");return}n.html("提交中....");this.giftLoading=true;var s=this.giftType;var o=this.giftInfo;var a=this;ajaxPostService("/service/SendGift",{bookid:a.bookId,type:a.giftType,count:t,score:e,giftcomment:i},function(e,i){a.giftLoading=false;if(i==1){Util.showMsgBox("网络连接异常，请稍后再试");return}if(i==2){Util.showMsgBox("系统错误，请稍后再试");return}if(e.Code!=0){if(e.Code==99){location.href="/UserValidator";return}Util.showMsgBox(e.Message,1e3);var r=s==4||s==8?"确认投给本书":"确认打赏";n.html(r);return}_userInfo.account=e.Account;$("#useraccount").html(e.Account);var f=0;var h=0;var u="";if(s!=4){if(s==8){var d=t*o.worth;h=Math.floor(d/1e4);f=d+h*100}else{h=a.addMonticketCount;f=a.addFensiCount}u="已送"+t+o.unitname+o.name}else{if(a.monticketMultiple>1){u="已送"+t+o.unitname+o.name+"+"+t+"张活动月票"}else{u="已送"+t+o.unitname+o.name}f=t*o.worth*a.monticketMultiple;a.todayCanSendMonticketCount-=t;a.monthCanSendMonticketCount-=t}if(h>0){u+="+"+h+"张月票"}u+="，粉丝值+"+f;switch(s){case 4:_userInfo.monTicket-=t;$("#mymonticscore").html(e.MonticScore);a.setMonTicket();break;case 8:if(_userInfo.assessTicket>=0){_userInfo.assessTicket=0}a.setCoin();a.setAssTicket();break;default:a.setCoin();a.setAssTicket();break}_userInfo.updateAccount();if(s>=38&&s<=40){var l="";if(s==38){a.expensiveGift.surplus1--;l="女王斗篷，今日还剩"+a.expensiveGift.surplus1+"件"}else if(s==39){a.expensiveGift.surplus2--;l="至尊权杖，今日还剩"+a.expensiveGift.surplus2+"根"}else{a.expensiveGift.surplus3--;l="绝代佳人，今日还剩"+a.expensiveGift.surplus3+"个"}a.expensiveGift.surplusTextObj.html(l);u+="，您的全站广播正在准备发布，若当前已有全站广播产生，则您的发布将有可能顺延一段时间。";if(e.ExAlert&&e.ExAlert!="")u=u+"<br>"+e.ExAlert;Util.showMsgBox(u,5e3)}else{if(e.ExAlert&&e.ExAlert!="")u=u+"<br>"+e.ExAlert;Util.showMsgBox(u)}})},setCommentTextLength:function(){var t=this.formatComment(this.dom.commentInput.val());this.dom.commentInput.val(t);this.dom.commentWords.html(t.length+"/2000")},formatComment:function(t){var e=/[^\u4e00-\u9fa5\sa-zA-Z0-9！，。？：‘’“”；！，．？：\(\)\[\]《》＂＂；\;\?\,\!\.\:\'\-\=\+]*$/gi;t=t.replace(e,"");e=/((http|https|rtsp|www)|[a-z0-9\-\_]{1,4}[\.]{1,}([a-z0-9\s]{2,5}))*$/gi;return t.replace(e,"")},sendComment:function(t){if(this.reviewLoading)return;var e=this.formatComment(this.dom.commentInput.val());this.dom.commentInput.val(e);if(e.length<5){Util.showMsgBox("请至少输入5个字！");return}if(e.length>2e3){Util.showMsgBox("最多只能输入2000个字！");return}var i=/[\u4E00-\u9FA5]/g;if(!i.test(e)){Util.showMsgBox("请输入一些中文字！");return}if(/(兼职|招聘)/.test(e)){Util.showMsgBox("非法词汇");return}this.reviewLoading=true;t.html("正在提交...");var n=this;ajaxPostService("/service/sendcomment",{bookid:n.bookId,comment:e},function(e,i){n.reviewLoading=false;if(i==1){Util.showMsgBox("网络连接异常，请稍后再试");return}if(i==2){Util.showMsgBox("系统错误，请稍后再试");return}t.html("发表评论");if(e.Code==0){Util.showMsgBox("评论发表成功！");n.dom.commentInput.val("");n.dom.commentWords.html("0/2000")}else{if(e.Code==99){location.href="/UserValidator";return}Util.showMsgBox(e.Message)}})}};window.reviewTextChange=function(){bookGift.setCommentTextLength()};window.showGiftBox=function(t,e,i,n){bookGift.init(t,e,i,n)};window.giftnumchange=function(t,e,i){bookGift.numChange(t,e,i)}})();